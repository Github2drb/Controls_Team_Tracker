                        currentWeek[dayOfWeek] = {
                            day: dayCounter,
                            date: dateStr,
                            projects: projectsForDay,
                            isToday: dateStr === today.toISOString().split('T')[0]
                        };
                        dayCounter++;
                    } else {
                        currentWeek[dayOfWeek] = null;
                    }
                    
                    if (dayOfWeek === 6) {
                        weeks.push(currentWeek);
                        currentWeek = new Array(7).fill(null);
                    }
                    
                    if (dayCounter > daysInMonth) break;
                }
                
                return `
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-3 text-white">
                            <h3 class="font-semibold text-lg">${monthName}</h3>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-7 gap-1 mb-2">
                                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                                    `<div class="text-center text-xs font-semibold text-slate-600 py-2">${day}</div>`
                                ).join('')}
                            </div>
                            <div class="grid grid-cols-7 gap-1">
                                ${weeks.map(week => week.map(day => {
                                    if (!day) return '<div class="calendar-day border border-slate-100 rounded bg-slate-50"></div>';
                                    
                                    return `
                                        <div class="calendar-day border ${day.isToday ? 'border-blue-500 border-2' : 'border-slate-200'} rounded p-2 ${day.isToday ? 'bg-blue-50' : 'bg-white'} hover:bg-slate-50 transition">
                                            <div class="text-sm font-semibold ${day.isToday ? 'text-blue-600' : 'text-slate-900'} mb-1">${day.day}</div>
                                            <div class="flex flex-wrap gap-1">
                                                ${day.projects.map(project => `
                                                    <div class="project-dot ${project.status === 'Completed' ? 'bg-green-500' : project.status === 'At Risk' ? 'bg-red-500' : project.status === 'On Hold' ? 'bg-yellow-500' : 'bg-blue-500'}" title="${project.projectName}"></div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('calendarSection').classList.remove('hidden');
            document.getElementById('calendarEngineer').textContent = engineerName;
        }

        function renderAllEngineersWeekView() {
            // Get all unique engineers
            const engineers = [...new Set(projects.map(p => p.engineerName))].sort();
            
            if (engineers.length === 0) {
                alert('No engineers found. Please add some project assignments first.');
                return;
            }

            // Collect all weeks across all projects
            const allWeeks = new Set();
            projects.forEach(project => {
                const start = new Date(project.startDate);
                const end = new Date(project.endDate);
                let current = new Date(start);

                while (current <= end) {
                    allWeeks.add(getWeekNumber(current));
                    current.setDate(current.getDate() + 7);
                }
            });

            const sortedWeeks = Array.from(allWeeks).sort();

            const content = document.getElementById('allEngineersContent');
            content.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="border border-slate-300 px-4 py-3 text-left font-semibold text-slate-900 sticky left-0 bg-slate-100 z-10 min-w-[150px]">Engineer</th>
                                ${sortedWeeks.map(week => {
                                    const range = getWeekDateRange(week);
                                    return `
                                        <th class="border border-slate-300 px-3 py-3 text-center font-semibold text-slate-900 min-w-[180px]">
                                            <div class="text-sm">${week}</div>
                                            <div class="text-xs text-slate-600 font-normal mt-1">${range.label}</div>
                                        </th>
                                    `;
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${engineers.map((engineer, idx) => {
                                const engineerProjects = projects.filter(p => p.engineerName === engineer);
                                
                                // Map projects to weeks for this engineer
                                const engineerWeekMap = {};
                                engineerProjects.forEach(project => {
                                    const start = new Date(project.startDate);
                                    const end = new Date(project.endDate);
                                    let current = new Date(start);

                                    while (current <= end) {
                                        const weekKey = getWeekNumber(current);
                                        if (!engineerWeekMap[weekKey]) {
                                            engineerWeekMap[weekKey] = [];
                                        }
                                        if (!engineerWeekMap[weekKey].find(p => p.id === project.id)) {
                                            engineerWeekMap[weekKey].push(project);
                                        }
                                        current.setDate(current.getDate() + 7);
                                    }
                                });

                                return `
                                    <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                        <td class="border border-slate-300 px-4 py-3 font-semibold text-slate-900 sticky left-0 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'} z-10">${engineer}</td>
                                        ${sortedWeeks.map(week => {
                                            const projectsInWeek = engineerWeekMap[week] || [];
                                            return `
                                                <td class="border border-slate-300 px-3 py-2 align-top">
                                                    ${projectsInWeek.length > 0 ? `
                                                        <div class="space-y-2">
                                                            ${projectsInWeek.map(project => `
                                                                <div class="text-xs p-2 rounded ${project.status === 'Completed' ? 'bg-green-100 border border-green-300' : project.status === 'At Risk' ? 'bg-red-100 border border-red-300' : project.status === 'On Hold' ? 'bg-yellow-100 border border-yellow-300' : 'bg-blue-100 border border-blue-300'}">
                                                                    <div class="font-semibold text-slate-900">${project.projectName}</div>
                                                                    <div class="text-slate-600 mt-1">${project.startDate} to ${project.endDate}</div>
                                                                    <div class="mt-1">
                                                                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${getStatusColor(project.status)}">
                                                                            ${project.status}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    ` : '<div class="text-center text-slate-400 text-xs">‚Äî</div>'}
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('allEngineersSection').classList.remove('hidden');
        }

        function closeAllEngineersView() {
            document.getElementById('allEngineersSection').classList.add('hidden');
        }

        function renderTable() {
            const filteredProjects = getFilteredProjects();
            const tbody = document.getElementById('tableBody');
            const tableCount = document.getElementById('tableCount');
            const tableTitle = document.getElementById('tableTitle');
            const filterType = document.getElementById('filterType').value;
            const filterValue = document.getElementById('filterValue').value;
            
            // Update table title
            if (filterType === 'all') {
                tableTitle.textContent = 'All Active Assignments';
            } else if (filterType === 'project' && filterValue) {
                tableTitle.textContent = `Project: ${filterValue}`;
            } else if (filterType === 'engineer' && filterValue) {
                tableTitle.textContent = `Engineer: ${filterValue}`;
            }
            
            tableCount.textContent = filteredProjects.length;
            document.getElementById('adminAssignmentCount').textContent = projects.length;

            // Show/hide calendar and week-wise sections based on filter
            if (filterType === 'engineer' && filterValue) {
                generateCalendarView(filterValue);
                generateWeekWiseBreakdown(filterValue);
            } else {
                document.getElementById('calendarSection').classList.add('hidden');
                document.getElementById('weekWiseSection').classList.add('hidden');
            }

            if (filteredProjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-slate-500 text-lg">No projects match your filter criteria.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredProjects.map(project => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4">
                        <div class="font-semibold text-slate-900">${project.projectName}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-slate-900">${project.engineerName}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-700">${project.startDate}</td>
                    <td class="px-6 py-4 text-slate-700">${project.endDate}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-800 font-bold">${project.assignedDays}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-12 h-12 rounded-full ${project.remainingDays === 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} font-bold">${project.remainingDays}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(project.status)}">${project.status}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-600">${project.notes || '‚Äî'}</td>
                    <td class="px-6 py-4 text-center">
                        ${isAdminMode() ? `<button onclick="deleteProject(${project.id})" class="text-red-600 hover:text-red-800 font-medium text-sm">Delete</button>` : '‚Äî'}
                    </td>
                </tr>
            `).join('');
        }

        function updateFilterOptions() {
            const filterType = document.getElementById('filterType').value;
            const filterSelectContainer = document.getElementById('filterSelectContainer');
            const filterValue = document.getElementById('filterValue');

            if (filterType === 'all') {
                filterSelectContainer.classList.add('hidden');
                renderTable();
                return;
            }

            filterSelectContainer.classList.remove('hidden');
            
            let options = [];
            if (filterType === 'project') {
                options = [...new Set(projects.map(p => p.projectName))].sort();
            } else if (filterType === 'engineer') {
                options = [...new Set(projects.map(p => p.engineerName))].sort();
            }

            filterValue.innerHTML = '<option value="">Choose...</option>' + 
                options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function clearFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterValue').value = '';
            document.getElementById('filterSelectContainer').classList.add('hidden');
            document.getElementById('calendarSection').classList.add('hidden');
            document.getElementById('weekWiseSection').classList.add('hidden');
            renderTable();
        }

        // Admin Authentication
        function toggleAdminAuth() {
            if (isAdminMode()) {
                exitAdmin();
            } else {
                document.getElementById('adminAuthModal').classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function closeAdminAuth() {
            document.getElementById('adminAuthModal').classList.add('hidden');
        }

        function verifyAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            const storedPassword = localStorage.getItem('adminPassword') || DEFAULT_PASSWORD;
            
            if (password === storedPassword) {
                localStorage.setItem('adminMode', 'true');
                closeAdminAuth();
                showAdminPanel();
            } else {
                alert('Incorrect password');
            }
        }

        function isAdminMode() {
            return localStorage.getItem('adminMode') === 'true';
        }

        function showAdminPanel() {
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('adminToggle').textContent = 'üëÅÔ∏è View Dashboard';
            document.getElementById('adminToggle').classList.remove('bg-slate-700', 'hover:bg-slate-600');
            document.getElementById('adminToggle').classList.add('bg-green-600', 'hover:bg-green-700');
            renderTable();
        }

        function exitAdmin() {
            localStorage.setItem('adminMode', 'false');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('adminToggle').textContent = 'üîê Admin Panel';
            document.getElementById('adminToggle').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('adminToggle').classList.add('bg-slate-700', 'hover:bg-slate-600');
            renderTable();
        }

        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            localStorage.setItem('adminPassword', newPassword);
            document.getElementById('newPassword').value = '';
            alert('Password updated successfully!');
        }

        function showCurrentPassword() {
            const password = localStorage.getItem('adminPassword') || DEFAULT_PASSWORD;
            alert(`Current admin password: ${password}`);
        }

        function downloadJSON() {
            const dataStr = JSON.stringify({ data: projects }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'data.json';
            link.click();
        }

        function downloadCSV() {
            const headers = ['Project Name', 'Engineer', 'Start Date', 'End Date', 'Total Days', 'Assigned Days', 'Remaining Days', 'Status', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...projects.map(p => [
                    `"${p.projectName}"`,
                    `"${p.engineerName}"`,
                    p.startDate,
                    p.endDate,
                    p.totalDays,
                    p.assignedDays,
                    p.remainingDays,
                    `"${p.status}"`,
                    `"${p.notes || ''}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'team_projects.csv';
            link.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will permanently delete all project data. This action cannot be undone!\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This is your final warning. All data will be lost. Continue?')) {
                    projects = [];
                    renderTable();
                    updateFilterOptions();
                    alert('All data has been cleared.');
                }
            }
        }

        // Event listener for Enter key in admin password field
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyAdminPassword();
            }
        });

        // Event listener for All Engineers button
        document.getElementById('allEngineersBtn').addEventListener('click', renderAllEngineersWeekView);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadDataFromJSON();
            
            if (isAdminMode()) {
                showAdminPanel();
            } else {
                renderTable();
            }
        });
    </script>
</body>
</html>